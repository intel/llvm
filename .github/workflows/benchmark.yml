name: Run Benchmarks

on:
  schedule:
    - cron: '0 1 * * *'  # 2 hrs earlier than sycl-nightly.yml
  workflow_call:
    inputs:
      commit_hash:
        type: string
        required: false
      upload_results:
        type: string # true/false: workflow_dispatch does not support booleans
        required: true
      runner:
        type: string
        required: true
      backend:
        type: string
        required: true
      reset_intel_gpu:
        type: string  # true/false: workflow_dispatch does not support booleans
        required: true
        default: true

  workflow_dispatch:
    inputs:
      commit_hash:
        description: Commit hash to build intel/llvm from
        type: string
        required: false
        default: ''
      upload_results:
        description: 'Save and upload results'
        type: choice
        options:
          - false
          - true
        default: true
      runner:
        type: choice
        options:
          - '["PVC_PERF"]'
      backend:
        description: Backend to use
        type: choice
        options:
          - 'level_zero:gpu'
        # TODO L0 V2 support
      reset_intel_gpu:
        description: Reset Intel GPUs
        type: choice
        options:
          - false
          - true
        default: true

permissions: read-all

jobs:
  build_sycl:
    name: Build SYCL from PR
    if: inputs.commit_hash != ''
    uses: ./.github/workflows/sycl-linux-build.yml
    with:
      build_ref: ${{ inputs.commit_hash }}
      build_cache_root: "/__w/"
      build_artifact_suffix: "default"
      build_cache_suffix: "default"
      # Docker image has last nightly pre-installed and added to the PATH
      build_image: "ghcr.io/intel/llvm/sycl_ubuntu2404_nightly:latest"
      cc: clang
      cxx: clang++
      changes: '[]'

  run_benchmarks_build:
    name: Run Benchmarks (on PR Build)
    needs: [ build_sycl ]
    if: inputs.commit_hash != ''
    strategy:
      matrix:
        # Set default values if not specified:
        include:
          - runner: ${{ inputs.runner || '["PVC_PERF"]' }}
            backend: ${{ inputs.backend || 'level_zero:gpu' }}
            reset_intel_gpu: ${{ inputs.reset_intel_gpu || 'true' }}
            ref: ${{ inputs.commit_hash }}
    uses: ./.github/workflows/sycl-linux-run-tests.yml
    secrets: inherit
    with:
      # TODO support other benchmarks
      name: Run compute-benchmarks (${{ matrix.runner }}, ${{ matrix.backend }})
      runner: ${{ matrix.runner }}
      image: ghcr.io/intel/llvm/sycl_ubuntu2404_nightly:latest
      image_options: -u 1001 --device=/dev/dri -v /dev/dri/by-path:/dev/dri/by-path --privileged --cap-add SYS_ADMIN
      target_devices: ${{ matrix.backend }}
      reset_intel_gpu: ${{ matrix.reset_intel_gpu }}
      tests_selector: benchmark_v2
      benchmark_upload_results: ${{ inputs.upload_results }}
      repo_ref: ${{ matrix.ref }}
      devops_ref: ${{ github.ref }}
      sycl_toolchain_artifact: sycl_linux_default
      sycl_toolchain_archive: ${{ needs.build_sycl.outputs.artifact_archive_name }}
      sycl_toolchain_decompress_command: ${{ needs.build_sycl.outputs.artifact_decompress_command }}

  run_benchmarks_nightly:
    name: Run Benchmarks (on Nightly Build)
    if: inputs.commit_hash == ''
    strategy:
      matrix:
        # Set default values if not specified:
        include:
          - runner: ${{ inputs.runner || '["PVC_PERF"]' }}
            backend: ${{ inputs.backend || 'level_zero:gpu' }}
            reset_intel_gpu: ${{ inputs.reset_intel_gpu || 'true' }}
    uses: ./.github/workflows/sycl-linux-run-tests.yml
    secrets: inherit
    with:
      # TODO support other benchmarks
      name: Run compute-benchmarks (${{ matrix.runner }}, ${{ matrix.backend }})
      runner: ${{ matrix.runner }}
      image: ghcr.io/intel/llvm/sycl_ubuntu2404_nightly:latest
      image_options: -u 1001 --device=/dev/dri -v /dev/dri/by-path:/dev/dri/by-path --privileged --cap-add SYS_ADMIN
      target_devices: ${{ matrix.backend }}
      reset_intel_gpu: ${{ matrix.reset_intel_gpu }}
      tests_selector: benchmark_v2
      benchmark_upload_results: ${{ inputs.upload_results }}
      repo_ref: ${{ github.ref }}
