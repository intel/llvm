name: SYCL Pre Commit

on:
  pull_request_target:
    # Do not run builds if changes are only in the following locations
    paths-ignore:
    - '.github/ISSUE_TEMPLATE/**'
    - '.github/CODEOWNERS'
    - '.github/workflows/sycl_update_gpu_driver.yml'
    - '.github/workflows/sycl_containers.yaml'
    - '.github/workflows/sycl_nightly.yml'
    - '.github/workflows/sycl_post_commit.yml'
    - '.github/workflows/sycl_windows_build_and_test.yml'
    - '.github/workflows/sycl_macos_build_and_test.yml'
    - 'devops/containers/**'
    - 'devops/scripts/install_drivers.sh'
    - 'devops/scripts/install_build_tools.sh'
    - 'sycl/doc/**'
    - 'sycl/gdb/**'
    - 'clang/docs/**'
    - '**.md'
    - '**.rst'

permissions:
  contents: read

jobs:
  lint:
    runs-on: cuda
    container:
      image: ghcr.io/intel/llvm/sycl_ubuntu2204_nightly:no-drivers
      # actions/checkout fails without "--privileged".
      options: -u 1001:1001 --privileged
    steps:
    - uses: actions/checkout@v3
      with:
        sparse-checkout: |
          devops/actions/cached_checkout
    - name: 'PR commits + 2'
      run: echo "PR_FETCH_DEPTH=$(( ${{ github.event.pull_request.commits }} + 2 ))" >> "${GITHUB_ENV}"
    - uses: ./devops/actions/cached_checkout
      with:
        path: src
        fetch-depth: ${{ env.PR_FETCH_DEPTH }}
        ref: ${{ github.event.pull_request.head.sha }}
        cache_path: "/__w/repo_cache/"
        merge: false
    - name: Run clang-format
      uses: ./src/devops/actions/clang-format
      with:
        path: src
