name: Allocate/Shutdown AWS CUDA Runner

on:
  workflow_run:
    workflows: [SYCL Experimental Pre-Commit]
    types:
      - in_progress
      - completed

jobs:
  aws:
    runs-on: ubuntu-20.04
    environment: aws
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: devops/actions/aws-ec2
      - run: npm install ./devops/actions/aws-ec2
      - id: mode
        run: |
          if [ "${{ github.event.action }}" == "completed" ]; then
              echo 'MODE=stop' >> $GITHUB_OUTPUT
          else
              echo 'MODE=start' >> $GITHUB_OUTPUT
          fi
      - uses: ./devops/actions/aws-ec2
        with:
          mode: ${{ steps.mode.outputs.MODE }}
          runs-on-list: '[{"runs-on":"aws_cuda-${{ github.event.workflow_run.id }}-${{ github.event.workflow_run.run_attempt }}","aws-ami":"ami-01cb0573cb039ab24","aws-type":["g5.2xlarge","g5.4xlarge"],"aws-disk":"/dev/sda1:64","aws-spot":"false"}]'
          GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
