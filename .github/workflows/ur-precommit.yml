name: Unified Runtime Pre Commit
# Note: this is the very first version of UR workflow.
# It was pretty much copy-pasted from UR repository.
# Over time it will be most likely integrated more into existing workflows.

# Note: the trigger is copy-pasted from sycl-linux-precommit.yml - probably to be fine-tuned.
on:
  # We rely on "Fork pull request workflows from outside collaborators" -
  # "Require approval for all outside collaborators" at
  # https://github.com/intel/llvm/settings/actions for security.
  pull_request:
    branches:
    - sycl
    - sycl-rel-**
    # Do not run builds if changes are only in the following locations
    paths-ignore:
    - '.github/ISSUE_TEMPLATE/**'
    - '.github/CODEOWNERS'
    - 'sycl/doc/**'
    - 'sycl/gdb/**'
    - 'clang/docs/**'
    - '**.md'
    - '**.rst'
    - '.github/workflows/sycl-windows-*.yml'
    - '.github/workflows/sycl-macos-*.yml'
    - '.github/workflows/sycl-nightly.yml'
    - '.github/workflows/sycl-rel-nightly.yml'
    - 'devops/containers/**'
    - 'devops/actions/build_container/**'

concurrency:
  #  Cancel a currently running workflow from the same PR, branch or tag.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  detect_changes:
    name: Detect Changes
    uses: ./.github/workflows/sycl-detect-changes.yml

  adapters:
    name: Adapters
    needs: [detect_changes]
    if: ${{ always() && !cancelled() && contains(needs.detect_changes.outputs.filters, 'ur') }}
    strategy:
      matrix:
      # Extra native CPU jobs are here to force the loader to be used.
      # UR will not use the loader if there is only one target.
        include:
          - name: CUDA
            runner: CUDA_UR
            image_options: -u 1001 --privileged --cap-add SYS_ADMIN --gpus all
    uses: ./.github/workflows/ur-build-hw.yml
    with:
      adapter_name: ${{ matrix.name }}
      runner_name: ${{ matrix.runner }}
      static_loader: ${{ matrix.static || 'OFF' }}
      static_adapter: ${{ matrix.static || 'OFF' }}
      other_adapter_name: ${{ matrix.other_adapter || '' }}
      docker_image: ${{ matrix.docker_image || 'ghcr.io/intel/llvm/ubuntu2404_intel_drivers:alldeps'}}
      image_options: ${{ matrix.image_options || '' }}
