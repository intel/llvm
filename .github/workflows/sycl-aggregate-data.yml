name: Collect aggregated data 
on:
  workflow_call:
# on:
#   schedule:
#     - cron: '0 0 * * *'  # Runs daily at midnight UTC
jobs:
  sycl-aggregate-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      # change to yesterday's date to match artifact names later
      - name: Calculate today's date
        id: date
        run: echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Download all load average artifacts from current run
        uses: actions/download-artifact@v4
        with:
          pattern: '*_load-average'
          path: artifacts
          merge-multiple: false
      
      - name: Process and aggregate data
        run: |
          echo "Processing artifacts from ${{ steps.date.outputs.TODAY }}"
          pwd 
          echo "Workspace contents:"
          ls -la
          echo "Downloaded artifacts structure:"
          ls -laR artifacts/
          
          echo "{" > aggregated_${{ steps.date.outputs.TODAY }}.json
          first_data=true

          # Each artifact is downloaded to its own subdirectory
          for artifact_dir in artifacts/*/; do
            echo "Processing directory: $artifact_dir"
            for file in "$artifact_dir"*.txt; do
              if [[ -f "$file" ]]; then
                filename=$(basename "$file" .txt)
                load=$(cat "$file" | xargs)
                
                if [ "$first_data" = true ]; then
                  echo "  \"$filename\": \"$load\"" >> aggregated_${{ steps.date.outputs.TODAY }}.json
                  first_data=false
                else
                  echo ",  \"$filename\": \"$load\"" >> aggregated_${{ steps.date.outputs.TODAY }}.json
                fi
              fi 
            done
          done

          echo "}" >> aggregated_${{ steps.date.outputs.TODAY }}.json
          
          cat aggregated_${{ steps.date.outputs.TODAY }}.json

      - name: Upload aggregated data artifact
        uses: actions/upload-artifact@v5
        with:
          name: aggregated_${{ steps.date.outputs.TODAY }}_data
          path: aggregated_${{ steps.date.outputs.TODAY }}.json
