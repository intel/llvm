name: Collect aggregated data 

on:
  workflow_call:
  push:
    branches:
      - luszczewskakasia1_monitoring

# on:
#   schedule:
#     - cron: '0 0 * * *'  # Runs daily at midnight UTC
jobs:
  sycl-aggregate-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      # change to yesterday's date to match artifact names later
      - name: Calculate today's date
        id: date
        run: |
          TODAY=$(date +'%Y-%m-%d')
          echo "TODAY=$TODAY" >> $GITHUB_OUTPUT
          echo "Date for artifact search: $TODAY"
      
      - name: Download all artifacts from today's health-check runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TODAY="${{ steps.date.outputs.TODAY }}"
          echo "Searching for all workflow runs from $TODAY"

          curl -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/sycl-health-check.yml/runs?status=success&created=>=${TODAY}" \
            | jq -r '.workflow_runs[].id' > run_ids.txt
          
          echo "Found workflow run IDs:"
          cat run_ids.txt
          
          mkdir -p artifacts
          
          # Download artifacts from each run using API
          while read run_id; do
            echo "Processing run $run_id"
            
            # Get artifacts for this run
            artifact_list=$(curl -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${run_id}/artifacts")
            
            # Download each artifact matching the date pattern
            echo "$artifact_list" | jq -r ".artifacts[] | select(.name | startswith(\"${TODAY}\")) | \"\(.id) \(.name)\"" | while read artifact_id artifact_name; do
              echo "Downloading artifact: $artifact_name (ID: $artifact_id)"
              
              # Download the artifact zip
              curl -L \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${artifact_id}/zip" \
                -o "${artifact_name}.zip"
              
              # Extract to artifacts directory
              mkdir -p "artifacts/${artifact_name}"
              unzip -q "${artifact_name}.zip" -d "artifacts/${artifact_name}"
              rm "${artifact_name}.zip"
            done
          done < run_ids.txt
          
          echo "All artifacts downloaded:"
          ls -laR artifacts/

      - name: Process and aggregate data
        run: |
          echo "Processing artifacts from ${{ steps.date.outputs.TODAY }}"
          ls -laR artifacts/
          echo "{" > aggregated_${{ steps.date.outputs.TODAY }}.json
          first_data=true

          for artifact_dir in artifacts/*/; do
            for file in "$artifact_dir"*.txt; do
              if [[ -f "$file" ]]; then
                filename=$(basename "$file" .txt)
                load=$(cat "$file" | xargs)
                
                if [ "$first_data" = true ]; then
                  echo "  \"$filename\": \"$load\"" >> aggregated_${{ steps.date.outputs.TODAY }}.json
                  first_data=false
                else
                  echo ",  \"$filename\": \"$load\"" >> aggregated_${{ steps.date.outputs.TODAY }}.json
                fi
              fi 
            done
          done

          echo "}" >> aggregated_${{ steps.date.outputs.TODAY }}.json
          
          cat aggregated_${{ steps.date.outputs.TODAY }}.json

      - name: Upload aggregated data artifact
        uses: actions/upload-artifact@v5
        with:
          name: aggregated_data_${{ steps.date.outputs.TODAY }}
          path: aggregated_${{ steps.date.outputs.TODAY }}.json
