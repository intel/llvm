name: Aggregate compute-benchmark averages from historical data

# The benchmarking workflow in sycl-linux-run-tests.yml passes or fails based on
# how the benchmark results compare to a historical average: This historical
# average is calculated in this workflow, which aggregates historical data and
# produces measures of central tendency (median in this case) used for this
# purpose.

on:
  workflow_dispatch:
    inputs:
      cutoff_timestamp:
        description: |
          Timestamp (YYYYMMDD_HHMMSS) indicating the age limit of data used in
          average calculation: Any benchmark results created before this 
          timestamp is excluded from being aggregated. 
        type: string
        required: true
  workflow_call:
    inputs:
      cutoff_timestamp:
        type: string
        required: true

permissions:
  contents: read

jobs:
  aggregate:
    name: Aggregate average (median) value for all metrics
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        sparse-checkout: |
          devops/scripts/benchmarking
          devops/benchmarking
    - name: Aggregate benchmark results and produce historical average
      uses: ./devops/actions/benchmarking/aggregate
      with:
        cutoff_timestamp: ${{ inputs.cutoff_timestamp }}
      env:
        GITHUB_TOKEN: ${{ secrets.LLVM_SYCL_BENCHMARK_TOKEN }}