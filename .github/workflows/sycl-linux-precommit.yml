name: SYCL Pre Commit on Linux

on:
  # We rely on "Fork pull request workflows from outside collaborators" -
  # "Require approval for all outside collaborators" at
  # https://github.com/intel/llvm/settings/actions for security.
  pull_request:
    branches:
    - sycl
    - sycl-rel-**
    # Do not run builds if changes are only in the following locations
    paths-ignore:
    - '.github/ISSUE_TEMPLATE/**'
    - '.github/CODEOWNERS'
    - 'sycl/cts_exclude_filter/**'
    - 'sycl/doc/**'
    - 'sycl/gdb/**'
    - 'clang/docs/**'
    - '**.md'
    - '**.rst'
    - '.github/workflows/sycl-windows-*.yml'
    - '.github/workflows/sycl-macos-*.yml'
    - '.github/workflows/sycl-nightly.yml'
    - '.github/workflows/sycl-rel-nightly.yml'
    - '.github/workflows/sycl-rel-nightly-launch.yml'
    - '.github/workflows/trivy.yml'
    - 'devops/containers/**'
    - 'devops/actions/build_container/**'
    - 'unified-runtime/examples/**'
    - 'unified-runtime/scripts/**'
    - 'unified-runtime/test/**'
    - 'unified-runtime/third_party/**'
    - 'unified-runtime/tools/**'

concurrency:
  #  Cancel a currently running workflow from the same PR, branch or tag.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build:
    name: Self build
    if: always() && success()
    uses: ./.github/workflows/sycl-linux-build.yml
    with:
      build_ref: ${{ github.sha }}
      build_cache_root: "/__w/"
      build_cache_suffix: "default"
      # Docker image has last nightly pre-installed and added to the PATH
      build_image: "ghcr.io/intel/llvm/sycl_ubuntu2404_nightly:latest"
      cc: clang
      cxx: clang++
      changes: '[]'

      toolchain_artifact: sycl_linux_default

  compat_read_exclude:
    name: Read compatibility testing exclude list
    runs-on: [Linux, build]
    outputs:
      FILTER: ${{ steps.result.outputs.FILTER }}
    steps:
    - uses: actions/checkout@v4
      with:
        sparse-checkout: |
          devops/
    - name: Register cleanup after job is finished
      uses: ./devops/actions/cleanup
    - id: result
      shell: bash
      run: |
        echo FILTER="$(grep -v '^#\|^\W*$' devops/compat_ci_exclude.sycl-rel-6_2 | paste -sd '|')" >> $GITHUB_OUTPUT


  compatibility:
    needs: [build, compat_read_exclude]
    if: ${{ always() && !cancelled() && needs.build.outputs.build_conclusion == 'success' }}
    uses: ./.github/workflows/sycl-linux-run-tests.yml
    with:
      name: E2E Backward ABI compatibility
      runner: '["Linux", "pvc"]'
      # FIXME:
      # image: ghcr.io/intel/llvm/sycl_prebuilt_tests:sycl-rel-6_2
      image: ghcr.io/intel/llvm/sycl_prebuilt_tests:e2e-preview-param
      image_options: -u 1001 --device=/dev/dri -v /dev/dri/by-path:/dev/dri/by-path --privileged --cap-add SYS_ADMIN
      target_devices: level_zero:gpu
      toolchain_artifact: ${{ needs.build.outputs.toolchain_artifact }}
      toolchain_artifact_filename: ${{ needs.build.outputs.toolchain_artifact_filename }}
      toolchain_decompress_command: ${{ needs.build.outputs.toolchain_decompress_command }}
      extra_lit_opts: '--param test-preview-mode=False --filter-out "${{ needs.compat_read_exclude.outputs.FILTER }}"'
      e2e_testing_mode: 'run-only'
